{% extends "roleplay_game_app/base.html" %}
{% block extra-css %}
<style>
    #chat-message-list {
        padding: 0;
        list-style: none;
    }
    .chat-message .message {
        background-color: #3b3b3d;
        color: #e1e1e1;
        border-radius: 0.8em;
        padding: 0.4em;
        margin: 0.4em 0;
        display: inline-block;
        white-space: pre-wrap;
    }

    .chat-message.me {
        text-align: right;
    }
    .chat-message.me .message {
        background-color: #1f8cff;
        color: #fff;
        text-align: left;
    }
    .chat-message .say{
        display: inline-block;
        font-size: .8em;
        margin-top: -0.4em;
        margin-left: 0.2em;
        cursor: pointer;
    }
    .chat-message .stopsay{
        display: inline-block;
        font-size: .8em;
        margin-top: -0.4em;
        margin-left: 0.2em;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    [{{ roleplayingroom.get_language_display }}
                    {{ roleplayingroom.get_level_display }}]
                    {{ roleplayingroom.situation }}
                    ({{ roleplayingroom.gpt_role }}ì™€ {{ roleplayingroom.my_role }}ì˜ ëŒ€í™”)
                </div>
                <div class="card-body">
                    <ul id="chat-message-list">
                        {# FIXME: ìƒ˜í”Œ ì±„íŒ… ë©”ì„¸ì§€ #}
                       <li class="chat-message">
                            <span class="message">ì£¼ì–´ì§„ ìƒí™©ê³¼ ì—­í• ì— ë§ê²Œ ëŒ€í™”í•´ë³´ì„¸ìš”! </span>
                        </li>
                        <li class="chat-message">
                            <span class="message">ë„ìš°ë¯¸ì˜ ë§ ì˜ë¯¸ê°€ ê¶ê¸ˆí•  ë•ŒëŠ” : "í•œêµ­ì–´ë¡œ ë§í•´ì¤˜" </span>
                        </li>
                        <li class="chat-message">
                            <span class="message">ì—¬ëŸ¬ë¶„ì˜ ë‹µë³€ì— ë¬¸ë²•ì  ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ë„ìš°ë¯¸ê°€ êµì •í•´ë“œë¦½ë‹ˆë‹¤! </span>
                        </li>
                         {% if roleplayingroom.language == 'en-US' %} 
                        <li class="chat-message">
                            <span class="message">Let's start the conversation!</span>
                        </li>
                        <li class="chat-message me">
                            <span class="message">Hi Nice to meet you!</span>
                        </li>
                        {% elif roleplayingroom.language == 'ja-JP' %}
                        <li class="chat-message">
                            <span class="message">ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</span>
                        </li>
                        <li class="chat-message me">
                            <span class="message">ã“ã‚“ã«ã¡ã¯ã€‚</span>
                        </li>
                        {% elif roleplayingroom.language == 'zh-CN' %}
                        <li class="chat-message">
                            <span class="message">è®©æˆ‘ä»¬å¼€å§‹å¯¹è¯å§</span>
                        </li>
                        <li class="chat-message me">
                            <span class="message">ä½ å¥½</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-footer">
                    <div class="d-grid gap-2 mb-2">
                        <button class="btn btn-primary" id="auto-play-button">
                            ë„ìš°ë¯¸ì˜ ë§ ìë™ ì½ì–´ì£¼ê¸°
                        </button>
                    </div>
                    <select id="voice-list" class="form-select mb-2"></select>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary" id="recommend-button">ì¶”ì²œë°›ê¸°</button>
                        <form id="message-form" class="d-flex gap-1 flex-grow-1">
                            <input type="text"
                                   name="message"
                                   placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
                                   class="form-control flex-grow-1" />
                        </form>
                        <button class="btn btn-danger" id="record">
                            <div class="icon">
                                <ion-icon name="mic-outline"></ion-icon>
                                <!-- <img src="bars.svg" alt="" /> -->
                            </div>
                            <!-- <p>Start Listening</p> -->
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="my-3">
        <a href="{% url 'role_playing_room_edit' roleplayingroom.pk %}"
           class="btn btn-primary">ìˆ˜ì •</a>
        <a href="{% url 'role_playing_room_delete' roleplayingroom.pk %}"
           class="btn btn-danger">ì‚­ì œ</a>
        <button class="btn btn-secondary" id="download">ëŒ€í™” íŒŒì¼ë¡œ ì €ì¥</button>
    </div>
{% endblock %}

{% block script %}
{{ roleplayingroom.pk|json_script:"room-pk" }}
{{ roleplayingroom.language|json_script:"room-language" }}


<script>
// ëŒ€í™”ì°½ í™”ë©´ì— ëŒ€í™” í•˜ë‚˜ì”© ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
function addMessage(message, isMe) {
    const messageList = document.getElementById("chat-message-list");
    const messageElement = document.createElement("li");
    messageElement.className = "chat-message" + (isMe ? " me" : "");
    // ëŒ€í™” ë©”ì„¸ì§€
    // ëŒ€í™” ë©”ì„¸ì§€ ì½ì–´ì£¼ê¸° ê¸°ëŠ¥
    messageElement.innerHTML = `
        <span class="message">${message}</span>
        <span class="say">ì½ì–´ì£¼ê¸°</span>   
        <span class="stopsay">ì½ê¸°ë©ˆì¶¤</span> 
    `;
    messageList.appendChild(messageElement);
    messageList.scrollTop = messageList.scrollHeight;
    // ì½ì–´ì£¼ê¸° ê¸°ëŠ¥
    messageElement.querySelector(".say").addEventListener("click", ()=>{
        sayMessage(message);
    });
    // ì½ì–´ì£¼ê¸° stop ê¸°ëŠ¥
    messageElement.querySelector(".stopsay").addEventListener("click", ()=>{
        window.speechSynthesis.cancel();  // ë©ˆì¶¤
    });

    // â­ï¸ ë©”ì„¸ì§€ ì €ì¥í•˜ê¸° ê¸°ëŠ¥
    //messageElement.querySelector(".savesay").addEventListener("click", ()=>{
        
    // });

}
// ì½ì–´ì£¼ê¸° í•¨ìˆ˜
function sayMessage(message){
    const voiceListSelect = document.querySelector("#voice-list");
    const option = voiceListSelect.options[voiceListSelect.selectedIndex];
    const voiceName = option.value;
    const voice = window.speechSynthesis.getVoices()
        .find(voice => voice.name === voiceName);
    const utterance = new SpeechSynthesisUtterance(message);
    utterance.voice = voice;
    utterance.lang = voice.lang;

    // ë°œí™” í• ìˆ˜ ì—†ëŠ” ì—ëŸ¬ ë°œìƒì‹œ
    // ì´ê±°í•˜ë©´ ë©ˆì¶¤ê¸°ëŠ¥ì„ ëª»ì”€
    //utterance.addEventListener("error", (e)=>{
    //    alert(`error : ${e.error}`);
    //});
    window.speechSynthesis.speak(utterance);  // ì½ì–´ì£¼ê¸°
}

// ëŒ€í™”ë‚´ì—­ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function download() {
    const allTexts = [];
    const allMessages = document.querySelectorAll("span.message");
    // ì•ì— ì„¤ëª… ë¶€ë¶„ì€ íŒŒì¼ì— ë“¤ì–´ê°€ì§€ ì•Šë„ë¡
    for (let i=3; i<allMessages.length; i++){
        text = allMessages[i].innerText;
        allTexts.push(text);
    }
    downloadText = allTexts.join('\n');
    console.log(downloadText);
    const filename = "roleplay.txt";
    const element = document.createElement("a");
    element.setAttribute(
        "href",
        "data:text/plain;charset=utf-8," + encodeURIComponent(downloadText)
    );
    element.setAttribute("download", filename);
    element.style.display = "none";
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);

}
 

// onloadë˜ë©´ ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ë¶€ë¶„
(function() {
    const room_pk = document.querySelector("#room-pk").textContent;
    const room_language = JSON.parse(document.querySelector('#room-language').textContent);
    const ws = new WebSocket(`ws://${window.location.host}/ws/chat/${room_pk}/`);
    let is_auto_play = false;


    // ì›¹ì†Œì¼“ì—ì„œ ë°œìƒí•˜ëŠ” 4ê°€ì§€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (open/ close/ error/message)
    ws.onopen = function(e) { console.log("ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ ì›¹ì†Œì¼“ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."); };
    ws.onclose = function(e) { console.log('ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.'); };
    ws.onerror = function(e) { console.error("ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ì˜ ì›¹ì†Œì¼“ ì—°ê²° ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", e); };
    // ì„œë²„ë¡œë¶€í„° ì›¹ì†Œì¼“ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜.
    ws.onmessage = function(e) {
        console.group("[onmessage]");
        const message_obj = JSON.parse(e.data);
        // ë„ìš°ë¯¸ì˜ ë§ í™”ë©´ì— ì¶”ê°€
        if ( message_obj.type === "assistant-message" ) {
            const { message } = message_obj;
            console.log("assistant-message:", message); 
            // ì±„íŒ… UI ì— ë©”ì„¸ì§€ ì¶”ê°€í•˜ëŠ” ì½”ë“œ
            addMessage(message, false);
            // ìë™ ìŒì„± ì¬ìƒ ê¸°ëŠ¥ (ë²„íŠ¼ ëˆŒëŸ¬ì•¼ì§€ ë°œë™)
            if(is_auto_play){
                sayMessage(message);
            }
        }
        // ì¶”ì²œ ë©”ì„¸ì§€ í™”ë©´ì— ì¶”ê°€
        else if ( message_obj.type === "recommended-message" ){
            const {message} = message_obj;
            console.log("recommend-message: ", message);  
            document.querySelector("#message-form [name='message']").value = message;  // ë„ì–´ì“°ê¸° ì£¼ì˜....ì•ˆí•˜ë©´ ì•ˆëœ¬ë‹¤.
            recommendButton.disabled = false;
        }
        // ì—ëŸ¬ë‚¬ì„ë•Œ
        else if ( message_obj.type === "openai-error" ) {
            const { message } = message_obj;
            alert(`Error: ${message}`);
        }
        else {
            console.error("ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…ì…ë‹ˆë‹¤.", message_obj);
        }
        console.groupEnd();
    };

    // ì„œë²„ë¡œ ë©”ì„¸ì§€ ìš”ì²­ ë³´ë‚´ê¸°
    const messageForm = document.getElementById("message-form");
    messageForm.onsubmit = function(e) {
        e.preventDefault();
        const message = e.target.message.value.trim();
        if(message.length > 0) {
            // ì„œë²„ë¡œ ì›¹ì†Œì¼“ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ì½”ë“œ.
            //  ì„œë²„ ë‹¨ì—ì„œ "ì „ë‹¬ë°›ì€ ë¬¸ìì—´"ì„ JSON ë””ì½”ë”©í•˜ë¯€ë¡œ
            //  í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ JSON ì¸ì½”ë”©í•œ ë¬¸ìì—´ì„ ì›¹ì†Œì¼“ìœ¼ë¡œ ì „ë‹¬
            addMessage(message, true);
            ws.send(JSON.stringify({ type: "user-message", message: message }));
            e.target.reset();
        }
    };

    // ì„œë²„(ì›¹ì†Œì¼“)ë¡œ ì¶”ì²œ ìš”ì²­ ë³´ë‚´ê¸°
    const recommendButton = document.querySelector("#recommend-button");
    recommendButton.addEventListener("click", () => {
        recommendButton.disabled = true;
        ws.send(JSON.stringify({type: "request-recommend-message"})); 
    });

    // ìë™ì¬ìƒ ê¸°ëŠ¥ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
    // ìë™ ì¬ìƒ ê¸°ëŠ¥ trueë¡œ ë³€ê²½
    const autoPlayButton = document.querySelector("#auto-play-button");
    autoPlayButton.addEventListener("click", ()=>{
        is_auto_play = true;
        autoPlayButton.remove();
    });

    // í˜ì´ì§€ ì²˜ìŒ ë¡œë“œ ë˜ì—ˆì„ ë•Œ ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„± ë¡œë“œë˜ì–´ì•¼í•¨ -> voiceschanged ì´ë²¤íŠ¸ ê¸°ë‹¤ë¦¼
    // safari ë™ì‘ ì•ˆë¨
    const synth = window.speechSynthesis;

    synth.onvoiceschanged = () => {
        const voices = synth.getVoices();  // getvoices ë©”ì†Œë“œ : ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ìŒì„± ê°€ì ¸ì˜¤ê¸°

        voices.forEach(({name, lang}) => {
            if (lang.toLowerCase() === room_language.toLowerCase()){
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                option.selected = true;  // ë””í´íŠ¸ë¡œ ë§ˆì§€ë§‰ ìŒì„± ì„ íƒ
                document.querySelector("#voice-list").appendChild(option);
            }
        })
    }
    // ìŒì„± ì¸ì‹ ê¸°ëŠ¥
    // ì±„íŒ…ë°© ì„¤ì • ì–¸ì–´ë¡œ ìŒì„±ì„ ì¸ì‹í•´ì„œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„
    // ë‚´ ì±„íŒ…ìœ¼ë¡œ ì¶”ê°€í•œë‹¤.
     // ğŸ”¥record buttonì˜ˆìœ ë²„ì ¼ í…ŒìŠ¤íŠ¸
    let recording = false;
    const recordBtn = document.getElementById("record");


    if(!("webkitSpeechRecognition" in window)){
        alert("ë§ˆì´í¬ ê¸°ëŠ¥ì€ í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.");
    }else{
        try{
            const speech = new webkitSpeechRecognition;
            speech.lang = room_language;  // room_languageë¡œ ëŒ€ì²´

            // start ëˆŒë €ì„ë•Œ
            recordBtn.addEventListener("click", () => {
                console.log("ìŒì„±ì¸ì‹ ë²„íŠ¼ ëˆŒë¦¼"); // í…ŒìŠ¤íŠ¸
                if (!recording) {
                    speech.start();
                    console.log('ìŒì„±ì¸ì‹ ì‹œì‘');
                    recording = true;
                } else {
                // stop ëˆŒë €ì„ë•Œ
                    speech.stop();
                    recording = false;
                    console.log('ìŒì„±ì¸ì‹ ì¤‘ì§€');
                    // ìŒì„±ì¸ì‹ ê²°ê³¼ ì¶œë ¥
                    speech.addEventListener("result", (event) =>{
                        const speechResult = event.results[0][0].transcript;
                        console.log(speechResult);
                        // ìŒì„±ì¸ì‹ ê²°ê³¼ë¥¼ ì±„íŒ… UIì— ë©”ì„¸ì§€ë¡œ ì¶”ê°€
                        // isMe = true (ë‚´ ë°œí™”)
                        addMessage(speechResult, true); 
                     });
                }
            });
                
            // ì—ëŸ¬ ì²˜ë¦¬
            speech.onerror = (event) => {
                stopRecording();  // ë…¹ìŒ ì¤‘ì§€

                if (event.error === "no-speech") {
                    alert("No speech was detected. Stopping...");
                } else if (event.error === "audio-capture") {
                    alert(
                    "ë°œê²¬ëœ ë§ˆì´í¬ê°€ ì—†ìŠµë‹ˆë‹¤."
                    );
                } else if (event.error === "not-allowed") {
                    alert("ë§ˆì´í¬ ì‚¬ìš©ì„ í—ˆê°€í•´ì£¼ì‹­ì‹œì˜¤.");
                } else if (event.error === "aborted") {
                    alert("Listening Stopped.");
                } else {
                    alert("ì¸ì‹ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + event.error);
                }   
            }; 
            } catch (error) {
                recording = false;
                console.log(error);
            }
        }
        // ëŒ€í™”ë‚´ì—­ textíŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
    const downloadBtn = document.getElementById("download");
    downloadBtn.addEventListener("click", download);  // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ

})();
</script>
{% endblock %}