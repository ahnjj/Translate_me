{% extends "roleplay_game_app/base.html" %}

{% block extra-css %}
<style>
    #chat-message-list {
        padding: 0;
        list-style: none;
    }
    .chat-message .message {
        background-color: #3b3b3d;
        color: #e1e1e1;
        border-radius: 1.2em;
        padding: 0.4em;
        margin: 0.4em 0;
        display: inline-block;
        white-space: pre-wrap;
    }

    .chat-message.me {
        text-align: right;
    }
    .chat-message.me .message {
        background-color: #1f8cff;
        color: #fff;
        text-align: left;
    }
    .chat-message .say{
        display: inline-block;
        font-size: .8em;
        margin-top: -0.4em;
        margin-left: 0.2em;
        cursor: pointer;
    }
    .chat-message .stopsay{
        display: inline-block;
        font-size: .8em;
        margin-top: -0.4em;
        margin-left: 0.2em;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-header">
                    [{{ roleplayingroom.get_language_display }}
                    {{ roleplayingroom.get_level_display }}]
                    {{ roleplayingroom.situation }}
                    ({{ roleplayingroom.helper_role }}(ì±—ë´‡) ì™€ {{ roleplayingroom.my_role }}(ë‚˜)ì˜ ëŒ€í™”)
                </div>
                <div class="card-body">
                    <ul id="chat-message-list">
                        {# FIXME: ìƒ˜í”Œ ì±„íŒ… ë©”ì„¸ì§€ #}
                       <li class="chat-message">
                            <span class="message">ì£¼ì–´ì§„ ìƒí™©ê³¼ ì—­í• ì— ë§ê²Œ ëŒ€í™”í•´ë³´ì„¸ìš”! </span>
                        </li>
                        <li class="chat-message">
                            <span class="message">ë„ìš°ë¯¸ì˜ ë§ ì˜ë¯¸ê°€ ê¶ê¸ˆí•  ë•ŒëŠ” : "í•œêµ­ì–´ë¡œ ë§í•´ì¤˜" </span>
                        </li>
                        <li class="chat-message">
                            <span class="message">ì—¬ëŸ¬ë¶„ì˜ ë‹µë³€ì— ë¬¸ë²•ì  ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ë„ìš°ë¯¸ê°€ êµì •í•´ë“œë¦½ë‹ˆë‹¤! </span>
                        </li>
                         {% if roleplayingroom.language == 'en-US' %} 
                        <li class="chat-message">
                            <span class="message">Let's start the conversation!</span>
                        </li>
                        <li class="chat-message me">
                            <span class="message">Hi Nice to meet you!</span>
                        </li>
                        {% elif roleplayingroom.language == 'ja-JP' %}
                        <li class="chat-message">
                            <span class="message">ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</span>
                        </li>
                        <li class="chat-message me">
                            <span class="message">ã“ã‚“ã«ã¡ã¯ã€‚</span>
                        </li>
                        {% elif roleplayingroom.language == 'zh-CN' %}
                        <li class="chat-message">
                            <span class="message">è®©æˆ‘ä»¬å¼€å§‹å¯¹è¯å§</span>
                        </li>
                        <li class="chat-message me">
                            <span class="message">ä½ å¥½</span>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-footer">
                    {% comment %} <div class="d-grid gap-2 mb-2">
                        <button class="btn btn-primary" id="auto-play-button">
                            ë„ìš°ë¯¸ì˜ ë§ ìë™ ì½ì–´ì£¼ê¸°
                        </button>
                    </div> {% endcomment %}
                    <div class="d-flex gap-2">
                        <!-- ë„ìš°ë¯¸ì˜ ë§ ìë™ ì½ì–´ì£¼ê¸° -->
                        <button class="btn" data-bs-toggle="button" id="auto-play-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-megaphone" viewBox="0 0 16 16">
                                <path d="M13 2.5a1.5 1.5 0 0 1 3 0v11a1.5 1.5 0 0 1-3 0v-.214c-2.162-1.241-4.49-1.843-6.912-2.083l.405 2.712A1 1 0 0 1 5.51 15.1h-.548a1 1 0 0 1-.916-.599l-1.85-3.49a68.14 68.14 0 0 0-.202-.003A2.014 2.014 0 0 1 0 9V7a2.02 2.02 0 0 1 1.992-2.013 74.663 74.663 0 0 0 2.483-.075c3.043-.154 6.148-.849 8.525-2.199V2.5zm1 0v11a.5.5 0 0 0 1 0v-11a.5.5 0 0 0-1 0zm-1 1.35c-2.344 1.205-5.209 1.842-8 2.033v4.233c.18.01.359.022.537.036 2.568.189 5.093.744 7.463 1.993V3.85zm-9 6.215v-4.13a95.09 95.09 0 0 1-1.992.052A1.02 1.02 0 0 0 1 7v2c0 .55.448 1.002 1.006 1.009A60.49 60.49 0 0 1 4 10.065zm-.657.975 1.609 3.037.01.024h.548l-.002-.014-.443-2.966a68.019 68.019 0 0 0-1.722-.082z"/>
                            </svg>
                        </button>        
                        <select id="voice-list" class="form-select mb-2"> 
                            <!-- <option value="" disabled selected>ì½ì–´ì¤„ ëª©ì†Œë¦¬ ì„ íƒ</option> -->
                        </select>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary" id="recommend-button">ì¶”ì²œë°›ê¸°</button>
                        <form id="message-form" class="d-flex gap-1 flex-grow-1">
                            <input type="text"
                                   name="message"
                                   placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."
                                   class="form-control flex-grow-1" />
                        </form>
                 
                            <!-- <ion-icon name="trash-outline"></ion-icon> -->
                            <button class="btn btn-danger" id="record">
                                <svg id = 'micoff' xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-mute" viewBox="0 0 16 16">
                                    <path d="M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879l-1-1V3a2 2 0 0 0-3.997-.118l-.845-.845A3.001 3.001 0 0 1 11 3z"/>
                                    <path d="m9.486 10.607-.748-.748A2 2 0 0 1 6 8v-.878l-1-1V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z"/>
                                  </svg>
                            </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="my-3">
        <a href="{% url 'role_playing_room_edit' roleplayingroom.pk %}"
           class="btn btn-primary"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
          </svg>
        </a>
        <a href="{% url 'role_playing_room_delete' roleplayingroom.pk %}"
           class="btn btn-danger"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
          </svg>
        </a>
        <button class="btn btn-secondary" id="download"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-down" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1-.5-.5v-8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 0 0 1h2A1.5 1.5 0 0 0 14 9.5v-8A1.5 1.5 0 0 0 12.5 0h-9A1.5 1.5 0 0 0 2 1.5v8A1.5 1.5 0 0 0 3.5 11h2a.5.5 0 0 0 0-1h-2z"/>
            <path fill-rule="evenodd" d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708l3 3z"/>
          </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block script %}

{{ roleplayingroom.pk|json_script:"room-pk" }}
{{ roleplayingroom.language|json_script:"room-language" }}


<script>
    // ëŒ€í™”ì°½ í™”ë©´ì— ëŒ€í™” í•˜ë‚˜ì”© ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    function addMessage(message, isMe) {
        const messageList = document.getElementById("chat-message-list");
        const messageElement = document.createElement("li");
        messageElement.className = "chat-message" + (isMe ? " me" : "");
        // ëŒ€í™” ë©”ì„¸ì§€
        // ëŒ€í™” ë©”ì„¸ì§€ ì½ì–´ì£¼ê¸° ê¸°ëŠ¥
        messageElement.innerHTML = `
        <span class="message">${message}</span>
        <span class="say">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-megaphone" viewBox="0 0 16 16"><path d="M13 2.5a1.5 1.5 0 0 1 3 0v11a1.5 1.5 0 0 1-3 0v-.214c-2.162-1.241-4.49-1.843-6.912-2.083l.405 2.712A1 1 0 0 1 5.51 15.1h-.548a1 1 0 0 1-.916-.599l-1.85-3.49a68.14 68.14 0 0 0-.202-.003A2.014 2.014 0 0 1 0 9V7a2.02 2.02 0 0 1 1.992-2.013 74.663 74.663 0 0 0 2.483-.075c3.043-.154 6.148-.849 8.525-2.199V2.5zm1 0v11a.5.5 0 0 0 1 0v-11a.5.5 0 0 0-1 0zm-1 1.35c-2.344 1.205-5.209 1.842-8 2.033v4.233c.18.01.359.022.537.036 2.568.189 5.093.744 7.463 1.993V3.85zm-9 6.215v-4.13a95.09 95.09 0 0 1-1.992.052A1.02 1.02 0 0 0 1 7v2c0 .55.448 1.002 1.006 1.009A60.49 60.49 0 0 1 4 10.065zm-.657.975 1.609 3.037.01.024h.548l-.002-.014-.443-2.966a68.019 68.019 0 0 0-1.722-.082z"/></svg>
        </span>   
        <span class="stopsay">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stop-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5v-3z"/></svg>
        </span> 
        `;
        messageList.appendChild(messageElement);
        messageList.scrollTop = messageList.scrollHeight;
        // ì½ì–´ì£¼ê¸° ê¸°ëŠ¥
        messageElement.querySelector(".say").addEventListener("click", ()=>{
            sayMessage(message);
        });
        // ì½ì–´ì£¼ê¸° stop ê¸°ëŠ¥
        messageElement.querySelector(".stopsay").addEventListener("click", ()=>{
            window.speechSynthesis.cancel();  // ë©ˆì¶¤
        });

    }
    // ì½ì–´ì£¼ê¸° í•¨ìˆ˜
    function sayMessage(message){
        const voiceListSelect = document.querySelector("#voice-list");
        const option = voiceListSelect.options[voiceListSelect.selectedIndex];
        const voiceName = option.value;
        const voice = window.speechSynthesis.getVoices()
            .find(voice => voice.name === voiceName);
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.voice = voice;
        utterance.lang = voice.lang;

        // ë°œí™” í• ìˆ˜ ì—†ëŠ” ì—ëŸ¬ ë°œìƒì‹œ
        // ì´ê±°í•˜ë©´ ë©ˆì¶¤ê¸°ëŠ¥ì„ ëª»ì”€
        //utterance.addEventListener("error", (e)=>{
        //    alert(`error : ${e.error}`);
        //});
        window.speechSynthesis.speak(utterance);  // ì½ì–´ì£¼ê¸°
    }

    // ëŒ€í™”ë‚´ì—­ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
    function download() {
        const allTexts = [];
        const meCheck = document.querySelectorAll("#chat-message-list li");
        const allMessages = document.querySelectorAll("span.message");
        allTexts.push('[ ìƒí™©ê·¹ìœ¼ë¡œ ì–¸ì–´ë¥¼ í•™ìŠµí•´ë´…ì‹œë‹¤! ]\n');
        // ì•ì— ì„¤ëª… ë¶€ë¶„ì€ ë¹¼ê³ 
        for (let i=3; i<allMessages.length; i++){
            if (meCheck[i].className == "chat-message"){
                text = 'ë„ìš°ë¯¸ : ' + allMessages[i].innerText;
            } else {
                text = 'ë‚˜ : '+ allMessages[i].innerText;
            }
            allTexts.push(text);
        }
        downloadText = allTexts.join('\n');
        console.log(downloadText);
        const filename = "roleplay.txt";
        const element = document.createElement("a");
        element.setAttribute(
            "href",
            "data:text/plain;charset=utf-8," + encodeURIComponent(downloadText)
        );
        element.setAttribute("download", filename);
        element.style.display = "none";
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);

    }
    // ê¸€ììˆ˜ ë„˜ìœ¼ë©´ ë°”ì´ë¯¸ ì»¤í”¼ë¡œ ë„˜ì–´ê°€ë„ë¡
function purchase() { 
    // location.replace("https://www.buymeacoffee.com/translateme"); 
    alert("ìœ ë£Œ ê²°ì œ ì°½ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.");
} 


// onloadë˜ë©´ ë°”ë¡œ ì‹¤í–‰ë˜ëŠ” ë¶€ë¶„
(function() {
    const room_pk = document.querySelector("#room-pk").textContent;
    const room_language = JSON.parse(document.querySelector('#room-language').textContent);
    const ws = new WebSocket(`ws://${window.location.host}/ws/roleplay/${room_pk}/`);
    let is_auto_play = false;


    // ğŸ”¥ìœ ë£ŒíšŒì›ìœ¼ë¡œ ë„˜ì–´ê°€ê¸° ìœ„í•¨ 
    var countText = 0; // ğŸ”¥í† í°ìˆ˜ ì„¸ê¸°
    let maxToken;  // ğŸ”¥ì–¸ì–´ ë³„ë¡œ ìµœëŒ€ ë¬´ë£Œ í† í°

    if (room_language == 'en-US'){
        maxToken = 1000;   // ì˜ì–´ : ì•½ 4~5ì² ì 1í† í° - ì‹¤ì œ ë°°í¬ì‹œ 4000í† í° ë¬´ë£Œì´ë¯€ë¡œ ì„¤ì • ë³€ê²½
    } else if (room_language == 'ja-JP'){
        maxToken = 100;  // ì¼ë³¸ì–´ : ì•½ 1ê¸€ì 1í† í° í…ŒìŠ¤íŠ¸ìš©
    } else {
        maxToken = 100;  // ì¤‘êµ­ì–´ : ì•½ 0.4ê¸€ì 1í† í°
    }



    // ì›¹ì†Œì¼“ì—ì„œ ë°œìƒí•˜ëŠ” 4ê°€ì§€ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (open/ close/ error/message)
    ws.onopen = function(e) { console.log("ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ ì›¹ì†Œì¼“ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."); };
    ws.onclose = function(e) { 
        console.log('ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.'); 
        alert("ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ ì›¹ì†Œì¼“ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤."); 
    }; 
    ws.onerror = function(e) { console.error("ì¥ê³  ì±„ë„ìŠ¤ ì„œë²„ì™€ì˜ ì›¹ì†Œì¼“ ì—°ê²° ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", e); };
    
    // ì„œë²„ë¡œë¶€í„° ì›¹ì†Œì¼“ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜.
    ws.onmessage = function(e) {
        console.group("[onmessage]");
        // console.log(typeof e.data);
        // console.log(e.data);

        const message_obj = JSON.parse(e.data);
        // ë„ìš°ë¯¸ì˜ ë§ í™”ë©´ì— ì¶”ê°€
        if ( message_obj.type === "assistant-message" ) {
            const { message } = message_obj;
            console.log("assistant-message:", message); 
            // ì±„íŒ… UI ì— ë©”ì„¸ì§€ ì¶”ê°€í•˜ëŠ” ì½”ë“œ
            addMessage(message, false);
            // ğŸ”¥ìœ ë£Œ
            countText += message.length;
            // ğŸ”¥ë°”ì´ë¯¸ ì»¤í”¼ë¡œ ë„˜ì–´ê°€ê¸°
            if (countText > maxToken) {
                console.log('ê²°ì œì°½');
                purchase();
            }

            // ìë™ ìŒì„± ì¬ìƒ ê¸°ëŠ¥ (ë²„íŠ¼ ëˆŒëŸ¬ì•¼ì§€ ë°œë™)
            if(is_auto_play){
                sayMessage(message);
            }
        }
        // ì¶”ì²œ ë©”ì„¸ì§€ í™”ë©´ì— ì¶”ê°€
        else if ( message_obj.type === "recommended-message" ){
            const {message} = message_obj;
            console.log("recommend-message: ", message);  
            document.querySelector("#message-form [name='message']").value = message;  // ë„ì–´ì“°ê¸° ì£¼ì˜....ì•ˆí•˜ë©´ ì•ˆëœ¬ë‹¤.
            recommendButton.disabled = false;
        }
        // ì—ëŸ¬ë‚¬ì„ë•Œ
        else if ( message_obj.type === "openai-error" ) {
            const { message } = message_obj;
            alert(`Error: ${message}`);
        }
        else {
            console.error("ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…ì…ë‹ˆë‹¤.", message_obj);
        }
        console.groupEnd();
    };

    // ì„œë²„ë¡œ ë©”ì„¸ì§€ ìš”ì²­ ë³´ë‚´ê¸°
    const messageForm = document.getElementById("message-form");
    messageForm.onsubmit = function(e) {
        e.preventDefault();
        const message = e.target.message.value.trim();
        if(message.length > 0) {
            // ì„œë²„ë¡œ ì›¹ì†Œì¼“ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•˜ëŠ” ì½”ë“œ.
            //  ì„œë²„ ë‹¨ì—ì„œ "ì „ë‹¬ë°›ì€ ë¬¸ìì—´"ì„ JSON ë””ì½”ë”©í•˜ë¯€ë¡œ
            //  í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ JSON ì¸ì½”ë”©í•œ ë¬¸ìì—´ì„ ì›¹ì†Œì¼“ìœ¼ë¡œ ì „ë‹¬
            addMessage(message, true);
            // ğŸ”¥ìœ ë£Œ
            countText += message.length;
            // ğŸ”¥ë°”ì´ë¯¸ ì»¤í”¼ë¡œ ë„˜ì–´ê°€ê¸°
            if (countText > maxToken) {
                console.log('ê²°ì œì°½');
                purchase();
            }
            ws.send(JSON.stringify({ type: "user-message", message: message }));
            e.target.reset();
        }
    };

    // ì„œë²„(ì›¹ì†Œì¼“)ë¡œ ì¶”ì²œ ìš”ì²­ ë³´ë‚´ê¸°
    const recommendButton = document.querySelector("#recommend-button");
    recommendButton.addEventListener("click", () => {
        recommendButton.disabled = true;
        ws.send(JSON.stringify({type: "request-recommend-message"})); 
    });

    // ğŸ”¥ì„œë²„ë¡œ ë™ì˜ì–´ ìš”ì²­ ë³´ë‚´ê¸°
    // const synonymButton = document.querySelector("#synonym-button");
    // recommendButton.addEventListener("click", () => {
    //     recommendButton.disabled = true;
    //     ws.send(JSON.stringify({type: "request-synonym-message"})); 
    // });

    // ìë™ì¬ìƒ ê¸°ëŠ¥ ë²„íŠ¼ ëˆŒë €ì„ ë•Œ
    // ìë™ ì¬ìƒ ê¸°ëŠ¥ trueë¡œ ë³€ê²½
    const autoPlayButton = document.querySelector("#auto-play-button");
    autoPlayButton.addEventListener("click", ()=>{
        is_auto_play = true;
        autoPlayButton.remove();
    });


    // í˜ì´ì§€ ì²˜ìŒ ë¡œë“œ ë˜ì—ˆì„ ë•Œ ì‚¬ìš© ê°€ëŠ¥í•œ ìŒì„± ë¡œë“œë˜ì–´ì•¼í•¨ -> voiceschanged ì´ë²¤íŠ¸ ê¸°ë‹¤ë¦¼
    // safari ë™ì‘ ì•ˆë¨
    const synth = window.speechSynthesis;

    synth.onvoiceschanged = () => {
        const voices = synth.getVoices();  // getvoices ë©”ì†Œë“œ : ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  ìŒì„± ê°€ì ¸ì˜¤ê¸°

        voices.forEach(({name, lang}) => {
            if (lang.toLowerCase() === room_language.toLowerCase()){
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                option.selected = true;  // ë””í´íŠ¸ë¡œ ë§ˆì§€ë§‰ ìŒì„± ì„ íƒ
                document.querySelector("#voice-list").appendChild(option);
            }
        })
    }
    // ìŒì„± ì¸ì‹ ê¸°ëŠ¥
    // ì±„íŒ…ë°© ì„¤ì • ì–¸ì–´ë¡œ ìŒì„±ì„ ì¸ì‹í•´ì„œ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„
    // ë‚´ ì±„íŒ…ìœ¼ë¡œ ì¶”ê°€í•œë‹¤.
     // ğŸ”¥record buttonì˜ˆìœ ë²„ì ¼ í…ŒìŠ¤íŠ¸
    let recording = false;
    const recordBtn = document.getElementById("record");


    if(!("webkitSpeechRecognition" in window)){
        alert("ë§ˆì´í¬ ê¸°ëŠ¥ì€ í¬ë¡¬ ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì§€ì›ë©ë‹ˆë‹¤.");
    }else{
        try{
            const speech = new webkitSpeechRecognition;
            speech.lang = room_language;  // room_languageë¡œ ëŒ€ì²´

            // start ëˆŒë €ì„ë•Œ
            recordBtn.addEventListener("click", () => {
                if (!recording) {
                    speech.start();
                    console.log('ìŒì„±ì¸ì‹ ì‹œì‘');
                    recording = true;

                    // ë…¹ìŒì¤‘ ì•„ì´ì½˜ìœ¼ë¡œ ë°”ê¾¸ê¸°
                    document.getElementById("micoff").style.display = 'none';

                    document.getElementById("record").innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
                                <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                                <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                            </svg>`;
                } else {
                // stop ëˆŒë €ì„ë•Œ
                    speech.stop();
                    recording = false;
                    console.log('ìŒì„±ì¸ì‹ ì¤‘ì§€');
                    // ë…¹ìŒ ì¤‘ì§€ ì•„ì´ì½˜ìœ¼ë¡œ ëŒë ¤ë†“ê¸°
                    document.getElementById("record").innerHTML = `<svg id = 'micoff' xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic-mute" viewBox="0 0 16 16">
                    <path d="M13 8c0 .564-.094 1.107-.266 1.613l-.814-.814A4.02 4.02 0 0 0 12 8V7a.5.5 0 0 1 1 0v1zm-5 4c.818 0 1.578-.245 2.212-.667l.718.719a4.973 4.973 0 0 1-2.43.923V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 1 0v1a4 4 0 0 0 4 4zm3-9v4.879l-1-1V3a2 2 0 0 0-3.997-.118l-.845-.845A3.001 3.001 0 0 1 11 3z"/>
                    <path d="m9.486 10.607-.748-.748A2 2 0 0 1 6 8v-.878l-1-1V8a3 3 0 0 0 4.486 2.607zm-7.84-9.253 12 12 .708-.708-12-12-.708.708z"/>
                    </svg>`;
    
                    // ìŒì„±ì¸ì‹ ê²°ê³¼ ì¶œë ¥
                    speech.addEventListener("result", (event) =>{
                        const speechResult = event.results[0][0].transcript;
                        console.log(speechResult);
                        // ìŒì„±ì¸ì‹ ê²°ê³¼ë¥¼ ì±„íŒ… UIì— ë©”ì„¸ì§€ë¡œ ì¶”ê°€
                        // isMe = true (ë‚´ ë°œí™”)
                        addMessage(speechResult, true); 
                        // 2. ìŒì„±ì¸ì‹ ê²°ê³¼ë¥¼ ëŒ€í™”ì°½ì— ë„£ê³  ì‹¶ì„ ê²½ìš°
                        // document.querySelector("#message-form [name='message']").value = speechResult;
                        ws.send(JSON.stringify({ type: "user-message", message: speechResult }));
                   
                     });
                }
            });
                         // ì—ëŸ¬ ì²˜ë¦¬
            speech.onerror = (event) => {
                stopRecording();  // ë…¹ìŒ ì¤‘ì§€
                if (event.error === "no-speech") {
                    alert("No speech was detected. Stopping...");
                } else if (event.error === "audio-capture") {
                    alert( "ë°œê²¬ëœ ë§ˆì´í¬ê°€ ì—†ìŠµë‹ˆë‹¤.");
                } else if (event.error === "not-allowed") {
                    alert("ë§ˆì´í¬ ì‚¬ìš©ì„ í—ˆê°€í•´ì£¼ì‹­ì‹œì˜¤.");
                } else if (event.error === "aborted") {
                    alert("Listening Stopped.");
                } else {
                    alert("ì¸ì‹ ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + event.error);
                }   
            }; 
            } catch (error) {
                recording = false;
                console.log(error);
            }
        }

        // ëŒ€í™”ë‚´ì—­ textíŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
    const downloadBtn = document.getElementById("download");
    downloadBtn.addEventListener("click", download);  // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ


})();
</script>
{% endblock %}